version: "3.8"

services:
  # PostgreSQL Database with pgvector
  postgres:
    image: ankane/pgvector:latest
    container_name: postgres_local
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-db_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password_placeholder}
      - POSTGRES_DB=${POSTGRES_DB:-n8n_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      internal:
        ipv4_address: 172.18.0.5
    labels:
      - "traefik.enable=false"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512m
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:latest
    container_name: redis
    volumes:
      - redis_data:/data
    networks:
      internal:
        ipv4_address: 172.18.0.3
    labels:
      - "traefik.enable=false"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256m
    restart: unless-stopped

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n_db}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-db_user}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-secure_password_placeholder}
      - DB_POSTGRESDB_SSL=false
      - EXECUTIONS_MODE=regular
      - CACHE_MODE=redis
      - CACHE_REDIS_HOST=redis
      - CACHE_REDIS_PORT=6379
      - CACHE_REDIS_DB=0
      - N8N_HOST=${N8N_DOMAIN:-n8n.example.com}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_EDITOR_BASE_URL=https://${N8N_DOMAIN:-n8n.example.com}
      - WEBHOOK_URL=https://${N8N_DOMAIN:-n8n.example.com}
      - N8N_LOG_LEVEL=info
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - NODE_FUNCTION_ALLOW_EXTERNAL=*
      - N8N_PUSH_BACKEND=websocket
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_TEMPLATES_ENABLED=false
      - GENERIC_TIMEZONE=${TIMEZONE:-UTC}
    volumes:
      - n8n_data:/home/node/.n8n
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${N8N_DOMAIN:-n8n.example.com}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.tls.certresolver=myresolver"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    networks:
      internal:
        ipv4_address: 172.18.0.6
    depends_on:
      - postgres
      - redis
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 4g
    restart: unless-stopped

  # OpenWebUI - Connects to Llama.cpp
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    environment:
      - OPENAI_API_BASE_URLS=http://llama:8080/
      - WEBUI_URL=https://${WEBUI_DOMAIN:-ui.example.com}
      - DATA_DIR=/app/backend/data
      - NO_PROXY=0.0.0.0,localhost,127.0.0.1,host.docker.internal
      - UV_SYSTEM_PYTHON=true
      - WEBUI_NAME=AICeo
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
    volumes:
      - openwebui_data:/app/backend/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openwebui.rule=Host(`${WEBUI_DOMAIN:-ui.example.com}`)"
      - "traefik.http.routers.openwebui.entrypoints=websecure"
      - "traefik.http.routers.openwebui.tls=true"
      - "traefik.http.routers.openwebui.tls.certresolver=myresolver"
      - "traefik.http.services.openwebui.loadbalancer.server.port=8080"
    networks:
      internal:
        ipv4_address: 172.18.0.7
    depends_on:
      - llama
      - redis
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2g
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # Llama.cpp (Ampere Optimized)
  llama:
    image: amperecomputingai/llama.cpp:latest
    container_name: llama
    entrypoint: /llm/llama-server
    command:
      - "--model"
      - "/models/qwen-3-4b-2507.gguf"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8080"
      - "--threads"
      - "3"
      - "--jinja"
      - "--flash-attn"
      - "auto"
      - "-sm"
      - "row"
      - "--temp"
      - "0.6"
      - "--top-k"
      - "20"
      - "--top-p"
      - "0.95"
      - "-c"
      - "40960"
      - "-n"
      - "32768"
      - "--no-mmap"
      - "--mlock"
    ports:
      - "8080:8080"
    volumes:
      - /opt/docker/llama/models:/models
      - /opt/docker/llama/data:/data
    networks:
      internal:
        ipv4_address: 172.18.0.8
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 18g
    restart: unless-stopped

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myresolver.acme.caserver=https://acme-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.myresolver.acme.email=${SSL_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
      - "--providers.file.filename=/etc/traefik/traefik_dynamic.yml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./acme.json:/letsencrypt/acme.json
      - ./traefik_dynamic.yml:/etc/traefik/traefik_dynamic.yml:ro
    networks:
      internal:
        ipv4_address: 172.18.0.2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https@docker"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256m
    restart: unless-stopped

  # Crawl4AI - Accessed via localhost:11235
  crawl4ai:
    image: unclecode/crawl4ai:latest
    container_name: crawl4ai
    shm_size: '2gb'
    ports:
      - "11235:11235"
    environment:
      - CRAWL4AI_API_TOKEN=${CRAWL4AI_TOKEN:-default_token_placeholder}
    volumes:
      - crawl4ai_data:/app/data
      - /dev/shm:/dev/shm
    networks:
      internal:
        ipv4_address: 172.18.0.9
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2g
    restart: unless-stopped

networks:
  internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16

volumes:
  postgres_data:
  n8n_data:
  openwebui_data:
  redis_data:
  letsencrypt:
  crawl4ai_data:
  langfuse_data:
  llama_data: